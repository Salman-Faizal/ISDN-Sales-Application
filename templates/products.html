{% extends "base.html" %} {% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">Products</h3>

  {% if role == "Admin" %}
  <a href="/add_product" class="btn btn-primary"> + Add Product </a>
  {% endif %}
</div>

{% if role == "Customer" %}
<form method="get" action="{{ url_for('products') }}" class="row g-2 mb-3">
  <div class="col-sm-8 col-md-5">
    <input
      type="text"
      name="product_name"
      class="form-control"
      placeholder="Search product by name"
      value="{{ product_search or '' }}"
    />
  </div>
  <div class="col-auto">
    <button type="submit" class="btn btn-primary">Search</button>
    <a href="{{ url_for('products') }}" class="btn btn-outline-secondary"
      >Clear</a
    >
  </div>
</form>
{% endif %}

<!-- PRODUCTS TABLE -->
<div class="card shadow-sm p-3 bg-white rounded-3">
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>ID</th>
          <th>Image</th>
          <th>Name</th>
          <th>Price</th>
          <th>Stock</th>
          <th width="200">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for product in products %}
        <tr>
          <td>{{ product[0] }}</td>

          <!-- IMAGE -->
          <td>
            {% if product[4] %}
            <img
              src="{{ url_for('static', filename='uploads/' + product[4]) }}"
              width="60"
              height="60"
              style="object-fit: cover; border-radius: 8px"
            />
            {% else %}
            <span class="text-muted">No Image</span>
            {% endif %}
          </td>

          <!-- NAME -->
          <td class="fw-semibold">{{ product[1] }}</td>

          <!-- PRICE -->
          <td>${{ product[2] }}</td>

          <!-- STOCK -->
          <td>
            {% if product[3] > 0 %}
            <span class="badge bg-success">{{ product[3] }}</span>
            {% else %}
            <span class="badge bg-danger">Out of Stock</span>
            {% endif %}
          </td>

          <!-- ACTIONS -->
          <td>
            {% if role == "Admin" %}
            <a
              href="/edit_product/{{ product[0] }}"
              class="btn btn-warning btn-sm"
            >
              Edit
            </a>

            <a
              href="/delete_product/{{ product[0] }}"
              class="btn btn-danger btn-sm"
              data-confirm-title="Delete Product"
              data-confirm-message="Are you sure you want to delete this product listing? This action cannot be undone."
              data-confirm-icon="bi-x-octagon-fill"
              data-confirm-button="Yes, Delete Product"
              data-confirm-button-class="btn-danger"
              data-confirm-class="js-confirm-action"
            >
              Delete
            </a>
            {% endif %} {% if role == "Customer" %} {% if product[3] > 0 %}
            <a href="/order/{{ product[0] }}" class="btn btn-success btn-sm">
              Order
            </a>
            {% else %}
            <button class="btn btn-secondary btn-sm" disabled>
              Unavailable
            </button>
            {% endif %} {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- CUSTOMER ORDERS SECTION -->
{% if role == "Customer" %}
<div class="card shadow-sm p-3 bg-white rounded-3 mt-4">
  <h5 class="mb-3">My Orders</h5>

  <div class="table-responsive">
    <table class="table table-bordered align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>Order ID</th>
          <th>Order Item</th>
          <th>Quantity</th>
          <th>Total Amount</th>
          <th>Status</th>
          <th>Payment</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for order in customer_orders %} {% set status_value = (order[1] or
        '')|lower %} {% set payment_value = (order[2] or '')|lower %}
        <tr>
          <td>{{ order[0] }}</td>
          <td>{{ order[3] }}</td>
          <td>{{ order[4] }}</td>
          <td>${{ '%.2f'|format(order[5] or 0) }}</td>

          <!-- STATUS -->
          <td>
            {% if status_value == "delivered" %}
            <span class="badge bg-success">Delivered</span>
            {% elif status_value == "out_for_delivery" %}
            <span class="badge bg-primary">Out For Delivery</span>
            {% elif status_value == "processing" %}
            <span class="badge bg-info text-dark">Processing</span>
            {% elif status_value == "confirmed" %}
            <span class="badge bg-secondary">Confirmed</span>
            {% elif status_value == "rejected" %}
            <span class="badge bg-danger">Rejected</span>
            {% elif status_value == "cancelled" %}
            <span class="badge bg-dark">Cancelled</span>
            {% else %}
            <span class="badge bg-warning text-dark">Pending</span>
            {% endif %}
          </td>

          <!-- PAYMENT -->
          <td>
            {% if payment_value == "paid" %}
            <span class="badge bg-success">Paid</span>
            {% else %}
            <span class="badge bg-danger">Unpaid</span>
            {% endif %}
          </td>

          <!-- PAYMENT ACTION -->
          <td>
            {% if order[1] == "Pending" %}
            <a
              href="/cancel_order/{{ order[0] }}"
              class="btn btn-outline-danger btn-sm"
              data-confirm-title="Cancel Order"
              data-confirm-message="Are you sure you want to cancel this order?"
              data-confirm-icon="bi-exclamation-triangle-fill"
              data-confirm-button="Yes, Cancel Order"
              data-confirm-button-class="btn-danger"
              data-confirm-class="js-confirm-action"
            >
              Cancel Order
            </a>
            {% elif payment_value == "unpaid" %}
            <a href="/pay/{{ order[0] }}" class="btn btn-warning btn-sm">
              Pay Now
            </a>
            {% else %}
            <span class="text-muted">â€”</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

<div
  id="confirmPopup"
  class="position-fixed top-0 start-0 w-100 h-100 d-none align-items-center justify-content-center"
  style="background: rgba(15, 23, 42, 0.55); z-index: 1080"
>
  <div class="card shadow border-0" style="max-width: 430px; width: 92%">
    <div class="card-body p-4 text-center">
      <div class="mb-3">
        <i
          id="confirmPopupIcon"
          class="bi bi-exclamation-triangle-fill text-danger fs-1"
        ></i>
      </div>
      <h5 id="confirmPopupTitle" class="mb-2">Confirm Action</h5>
      <p id="confirmPopupMessage" class="text-muted mb-4"></p>
      <div class="d-flex gap-2 justify-content-center">
        <button
          id="confirmPopupCancel"
          type="button"
          class="btn btn-outline-secondary"
        >
          Keep Product
        </button>
        <button id="confirmPopupOk" type="button" class="btn btn-danger">
          Confirm
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  (() => {
    const popup = document.getElementById("confirmPopup");
    if (!popup) return;

    const title = document.getElementById("confirmPopupTitle");
    const message = document.getElementById("confirmPopupMessage");
    const icon = document.getElementById("confirmPopupIcon");
    const cancelBtn = document.getElementById("confirmPopupCancel");
    const okBtn = document.getElementById("confirmPopupOk");
    let pendingUrl = null;

    const hidePopup = () => {
      popup.classList.add("d-none");
      popup.classList.remove("d-flex");
      pendingUrl = null;
    };

    document
      .querySelectorAll('[data-confirm-class="js-confirm-action"]')
      .forEach((link) => {
        link.addEventListener("click", (event) => {
          event.preventDefault();
          pendingUrl = link.getAttribute("href");

          title.textContent = link.dataset.confirmTitle || "Confirm Action";
          message.textContent =
            link.dataset.confirmMessage || "Are you sure you want to continue?";
          icon.className = `bi ${link.dataset.confirmIcon || "bi-exclamation-triangle-fill"} text-danger fs-1`;
          okBtn.textContent = link.dataset.confirmButton || "Confirm";
          okBtn.className = `btn ${link.dataset.confirmButtonClass || "btn-danger"}`;

          cancelBtn.textContent = pendingUrl.includes("delete_product")
            ? "Keep Product"
            : "Keep Order";

          popup.classList.remove("d-none");
          popup.classList.add("d-flex");
        });
      });

    cancelBtn.addEventListener("click", hidePopup);
    popup.addEventListener("click", (event) => {
      if (event.target === popup) hidePopup();
    });
    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape" && !popup.classList.contains("d-none")) {
        hidePopup();
      }
    });

    okBtn.addEventListener("click", () => {
      if (pendingUrl) {
        window.location.href = pendingUrl;
      }
    });
  })();
</script>
{% endblock %}
